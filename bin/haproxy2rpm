#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'rubygems'
require 'optparse'

NEW_RELIC_CONFIG_PATH = File.join(ENV['HOME'], '.newrelic', 'newrelic.yml')

help = <<HELP
haproxy2rpm

Basic Command Line Usage:
  haproxy2rpm <haproxy log file to parse>

  Coniguration for newrelic is read from #{NEW_RELIC_CONFIG_PATH}
HELP

options = { :daemonize => false, :version => false }

opts = OptionParser.new do |opts|
  opts.banner = help
  opts.on("-D", "--daemonize", "Daemonize") do
    options[:daemonize] = true
  end
  
  opts.on("-v", "--version", "Print the version number and exit") do
    options[:version] = true
  end
end

opts.parse!

require 'haproxy2rpm'

log_file = ARGV[0] || ''

if(options[:version])
 puts "Haproxy2Rpm version: #{Haproxy2Rpm::VERSION}"
 exit(0)
end

unless File.exists?(log_file)
  puts 'please proivde a valid path to a haproxy log file'
  puts ''
  puts help
  exit(1)
end

unless File.exists?(NEW_RELIC_CONFIG_PATH)
  puts "please copy your newrelic agent configuration to #{NEW_RELIC_CONFIG_PATH}"
  exit(1)
end

trap("SIGINT") { 
  Haproxy2Rpm.stop
  exit(0)
}
Haproxy2Rpm.run(log_file, options)
